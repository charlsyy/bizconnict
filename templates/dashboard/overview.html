{% extends "dashboard/base_admin.html" %}
{% load static %}
{% block title %}Dashboard â€” BizConnect Admin{% endblock %}
{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
{% endblock %}

{% block admin_content %}
<div class="admin-header">
  <span class="label">Admin</span>
  <h1 class="mt-1">Overview</h1>
</div>

<div class="grid-4 mb-6">
  <div class="stat-card gold"><div class="stat-value">{{ total_users }}</div><div class="stat-label">Total Users</div></div>
  <div class="stat-card"><div class="stat-value">{{ total_products }}</div><div class="stat-label">Products</div></div>
  <div class="stat-card"><div class="stat-value">{{ total_orders }}</div><div class="stat-label">Orders</div></div>
  <div class="stat-card gold"><div class="stat-value" style="font-size:1.3rem;">&#8369;{{ total_revenue|floatformat:2 }}</div><div class="stat-label">Revenue</div></div>
</div>

{% if pending_reports > 0 %}
<div class="alert alert-warning mb-5">
  {{ pending_reports }} pending report{{ pending_reports|pluralize }} awaiting review. <a href="{% url 'admin_reports' %}">Review now</a>
</div>
{% endif %}

<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-5);margin-bottom:var(--sp-6);">
  <div class="panel">
    <h3 class="mb-4">Top Sellers</h3>
    <canvas id="sellersChart" height="200"></canvas>
  </div>
  <div class="panel">
    <h3 class="mb-4">Recent Orders</h3>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Order #</th><th>Buyer</th><th>Total</th><th>Status</th></tr></thead>
        <tbody>
          {% for o in recent_orders %}
          <tr>
            <td style="font-family:var(--font-display);font-size:13px;">{{ o.order_number }}</td>
            <td>{{ o.buyer.username }}</td>
            <td>&#8369;{{ o.total_amount|floatformat:2 }}</td>
            <td><span class="badge {% if o.status == 'delivered' %}badge-success{% elif o.status == 'cancelled' %}badge-danger{% else %}badge-warning{% endif %}" style="font-size:10px;">{{ o.get_status_display }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
new Chart(document.getElementById('sellersChart'), {
  type: 'bar',
  data: {
    labels: [{% for s in top_sellers %}'{{ s.seller__username }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      label: 'Revenue (PHP)',
      data: [{% for s in top_sellers %}{{ s.revenue|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: 'rgba(201,169,110,0.8)',
      borderColor: '#A07840',
      borderWidth: 1,
      borderRadius: 6,
    }]
  },
  options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
});
</script>
{% endblock %}