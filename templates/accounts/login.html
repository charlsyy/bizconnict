{% extends "base.html" %}
{% block title %}Sign In — BizConnect{% endblock %}

{% block extra_head %}
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
.auth-page {
  min-height: calc(100vh - var(--nav-h));
  display: grid; place-items: center;
  padding: var(--sp-7) var(--sp-4);
  background: linear-gradient(160deg, var(--ivory) 60%, var(--ivory-dark) 100%);
}
.auth-box {
  width: 100%; max-width: 420px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  padding: var(--sp-7) var(--sp-6);
  box-shadow: var(--sh-lg);
}
.auth-logo { font-family: var(--font-display); font-size: 1.6rem; font-weight: 700; color: var(--charcoal); margin-bottom: 4px; }
.auth-logo span { color: var(--gold); }
.auth-sub { color: var(--text-2); font-size: 14px; margin-bottom: var(--sp-6); }
.divider-text { text-align: center; position: relative; margin: var(--sp-5) 0; }
.divider-text::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border); }
.divider-text span { background: var(--surface); padding: 0 12px; position: relative; font-size: 13px; color: var(--text-3); }
</style>
{% endblock %}

{% block content %}
<div class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">Biz<span>Connect</span></div>
    <p class="auth-sub">Welcome back. Sign in to continue.</p>

    <div id="err" class="alert alert-error hidden"></div>

    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="email" class="form-control" placeholder="you@example.com" autocomplete="email" />
    </div>

    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Your password" autocomplete="current-password" />
    </div>

    <button type="button" onclick="doLogin()" id="submit-btn" class="btn btn-dark btn-block mt-4" style="padding:13px;">
      Sign In
    </button>

    <div class="divider-text"><span>New here?</span></div>
    <div style="display:flex;gap:var(--sp-2);">
      <a href="{% url 'register' %}?role=buyer" class="btn btn-outline btn-block">Buyer</a>
      <a href="{% url 'register' %}?role=seller" class="btn btn-gold btn-block">Seller</a>
    </div>
  </div>
</div>
<div style="text-align:center;margin-top:var(--sp-3);">
  <a href="{% url 'fallback_login' %}" style="font-size:12px;color:var(--text-3);">
    Having trouble signing in? Use standard login
  </a>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCbi58-AfOB9awW1kFzDI9im2R8MqJ0d88",
    authDomain: "bizconnect-ac6cb.firebaseapp.com",
    projectId: "bizconnect-ac6cb",
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  function getCSRF() {
    const csrfFromTemplate = "{{ csrf_token }}";
    return (csrfFromTemplate && csrfFromTemplate !== "NOTPROVIDED")
      ? csrfFromTemplate
      : getCookie('csrftoken');
  }

  function isEmail(s) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
  }

  async function doLogin() {
    const emailOrUser = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    const err = document.getElementById('err');
    const btn = document.getElementById('submit-btn');

    err.classList.add('hidden');
    err.textContent = '';

    if (!emailOrUser || !pass) {
      err.textContent = 'Email/Username and password required.';
      err.classList.remove('hidden');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Signing in…';

    try {
      // ✅ If NOT an email => treat as Django username login (ADMIN)
      if (!isEmail(emailOrUser)) {
        const resp = await fetch("{% url 'standard_auth' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRF(),
          },
          body: JSON.stringify({
            username: emailOrUser,
            password: pass
          }),
        });

        const text = await resp.text();
        let data = {};
        try { data = JSON.parse(text); } catch (_) {}

        if (resp.ok && data.success) {
          window.location.href = data.redirect || "/dashboard/";
          return;
        }

        err.textContent = (data && (data.error || data.detail)) || `Login failed (HTTP ${resp.status}).`;
        err.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'Sign In';
        return;
      }

      // ✅ Else: Firebase email login (buyers/sellers)
      const cred = await firebase.auth().signInWithEmailAndPassword(emailOrUser, pass);
      const token = await cred.user.getIdToken(true);

      const resp = await fetch("{% url 'firebase_auth' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRF(),
        },
        body: JSON.stringify({
          id_token: token,
          idToken: token,
          email: emailOrUser
        }),
      });

      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch (_) {}

      if (resp.ok && data.success) {
        window.location.href = data.redirect || "/";
        return;
      }

      err.textContent = (data && (data.error || data.detail)) || `Login failed (HTTP ${resp.status}).`;
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'Sign In';

    } catch (e) {
      err.textContent = (e && e.message) ? e.message : 'Login failed.';
      err.classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'Sign In';
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doLogin();
  });
</script>
{% endblock %}