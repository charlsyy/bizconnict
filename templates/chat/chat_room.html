{% extends "base.html" %}
{% block title %}Chat with {{ other.username }} — BizConnect{% endblock %}

{% block content %}
<div class="page-content">
  <div class="glass" style="max-width:680px;margin:0 auto;padding:0;overflow:hidden;">
    <!-- Header -->
    <div style="padding:var(--space-md) var(--space-lg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:var(--space-md);background:var(--surface-solid);">
      <a href="{% url 'conversation_list' %}" style="color:var(--text-muted);font-size:20px;">←</a>
      <div style="width:40px;height:40px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">
        {{ other.username|first|upper }}
      </div>
      <div>
        <div style="font-weight:700;">{{ other.username }}</div>
        <div style="font-size:var(--font-size-xs);color:var(--text-muted);">
          {% if other.profile.role %}{{ other.profile.get_role_display }}{% endif %}
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" style="height:420px;overflow-y:auto;padding:var(--space-lg);display:flex;flex-direction:column;gap:var(--space-sm);background:var(--bg);">
      {% for m in messages %}
      <div style="display:flex;flex-direction:column;align-items:{% if m.sender == request.user %}flex-end{% else %}flex-start{% endif %};">
        <div class="bubble {% if m.sender == request.user %}bubble-mine{% else %}bubble-theirs{% endif %}">
          {{ m.body }}
        </div>
        <div class="bubble-time" style="{% if m.sender == request.user %}text-align:right;{% endif %}">
          {{ m.created_at|time:"H:i" }}
          {% if m.sender == request.user %}
            <span style="font-size:9px;opacity:0.6;">
              {% if m.is_read %}&#10003;&#10003; Seen{% else %}&#10003; Sent{% endif %}
            </span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Input -->
    <div style="padding:var(--space-md) var(--space-lg);border-top:1px solid var(--border);background:var(--surface-solid);display:flex;gap:var(--space-sm);">
      <input type="text" id="msg-input" class="form-control" placeholder="Type a message…" onkeydown="if(event.key==='Enter')sendMsg();" style="flex:1;" />
      <button onclick="sendMsg()" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<script>
const CONV_ID = {{ conv.id }};
let lastId = {{ messages.last.id|default:0 }};

function scrollBottom() {
  const el = document.getElementById('messages');
  el.scrollTop = el.scrollHeight;
}
scrollBottom();

function esc(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function appendMsg(m) {
  const container = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex;flex-direction:column;align-items:' + (m.is_mine ? 'flex-end' : 'flex-start') + ';';

  const receipt = m.is_mine
    ? '<div style="font-size:9px;color:var(--text-3);margin-top:2px;text-align:right;">'
      + (m.is_read ? '&#10003;&#10003; Seen' : '&#10003; Sent')
      + '</div>'
    : '';

  wrap.innerHTML =
    '<div class="bubble ' + (m.is_mine ? 'bubble-mine' : 'bubble-theirs') + '">'
    + esc(m.body) + '</div>'
    + '<div class="bubble-time" style="' + (m.is_mine ? 'text-align:right;' : '') + '">'
    + m.time + '</div>'
    + receipt;

  container.appendChild(wrap);
  scrollBottom();
}

async function sendMsg() {
  const input = document.getElementById('msg-input');
  const body = input.value.trim();
  if (!body) return;
  input.value = '';

  const resp = await fetch(`/chat/${CONV_ID}/send/`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
    body: JSON.stringify({ body }),
  });

  const data = await resp.json();
  if (data.id) {
    lastId = data.id;
    appendMsg(data);
  }
}

async function pollMessages() {
  try {
    const resp = await fetch(`/chat/${CONV_ID}/fetch/?since=${lastId}`);
    const data = await resp.json();
    if (data.messages && data.messages.length) {
      data.messages.forEach(m => {
        lastId = m.id;
        appendMsg(m);
      });
    }
  } catch(e) {}
}
setInterval(pollMessages, 1200);

function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
</script>
{% endblock %}