{% extends "base.html" %}
{% load feed_extras %}
{% block title %}Feed â€” BizConnect{% endblock %}
{% block content %}

<div class="page" style="max-width:700px;">
  <span class="label">Community</span>
  <h1 class="mt-1 mb-5">Feed</h1>

  <!-- Composer -->
  <div class="panel mb-5">
    <form method="post" action="{% url 'create_post' %}" enctype="multipart/form-data" id="post-form">
      {% csrf_token %}
      <div class="flex gap-3 mb-3">
        <div class="avatar avatar-md" style="flex-shrink:0;">
          {% if request.user.profile.avatar %}
            <img src="{{ request.user.profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
          {% else %}
            {{ request.user.username|first|upper }}
          {% endif %}
        </div>
        <textarea name="text" class="form-control" rows="2" placeholder="What's on your mind, {{ request.user.first_name|default:request.user.username }}?"></textarea>
      </div>

      <div class="flex-between" style="flex-wrap:wrap;gap:var(--sp-2);">
        <div class="flex gap-2">
          <label class="btn btn-ghost btn-sm" style="cursor:pointer;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Photo
            <input type="file" name="image" accept="image/*" style="display:none;" />
          </label>

          <label class="btn btn-ghost btn-sm" style="cursor:pointer;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
            Video
            <input type="file" name="video" accept="video/*" style="display:none;" />
          </label>
        </div>

        <button type="submit" class="btn btn-gold btn-sm">Post</button>
      </div>
    </form>
  </div>

  <!-- Posts -->
  {% for post in posts %}
  <div class="card mb-4" id="post-{{ post.id }}">
    <div class="card-body">

      <div class="flex gap-3 mb-3">
        <div class="avatar avatar-md" style="flex-shrink:0;">
          {% if post.author.profile.avatar %}
            <img src="{{ post.author.profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />
          {% else %}
            {{ post.author.username|first|upper }}
          {% endif %}
        </div>

        <div style="flex:1;">
          <div style="font-weight:600;font-size:14px;">{{ post.author.username }}</div>
          <div class="text-xs text-muted">{{ post.created_at|timesince }} ago</div>
        </div>

        {% if post.author == request.user or request.user.is_staff %}
        <form method="post" action="{% url 'delete_post' post.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-ghost btn-sm" style="color:var(--text-3);" onclick="return confirm('Delete this post?')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6m4-6v6"/><path d="M9 6V4h6v2"/></svg>
          </button>
        </form>
        {% endif %}
      </div>

      <p style="color:var(--text);line-height:1.7;margin-bottom:{% if post.image or post.video %}var(--sp-3){% else %}0{% endif %};">
        {{ post.text }}
      </p>

      {% if post.image %}
        <img src="{{ post.image.url }}" alt="" style="width:100%;border-radius:var(--r-sm);margin-top:var(--sp-2);" />
      {% endif %}
      {% if post.video %}
        <video src="{{ post.video.url }}" controls style="width:100%;border-radius:var(--r-sm);margin-top:var(--sp-2);"></video>
      {% endif %}

      <!-- Reactions -->
      <div class="reactions mt-3">
        {% for rkey, rlabel in reaction_icons.items %}
        <button
          type="button"
          class="reaction-btn {% if user_reactions|get_item:post.id == rkey %}active{% endif %}"
          onclick="react({{ post.id }}, '{{ rkey }}', this)"
          data-type="{{ rkey }}"
        >
          <span class="reaction-icon">{{ reaction_icons|get_item:rkey }}</span>
          <span class="reaction-count-{{ post.id }}-{{ rkey }}">
            {{ post.reaction_summary|reaction_count:rkey }}
          </span>
        </button>
        {% endfor %}
      </div>

    </div>
  </div>
  {% empty %}
  <div class="panel text-center" style="padding:var(--sp-7);">
    <p class="text-muted">No posts yet. Be the first to share!</p>
  </div>
  {% endfor %}
</div>

<script>
async function react(postId, type, btn) {
  try {
    const resp = await fetch(`/feed/post/${postId}/react/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ reaction_type: type }),
    });

    const data = await resp.json();

    if (data && data.counts) {
      btn.closest('.reactions').querySelectorAll('.reaction-btn')
        .forEach(b => b.classList.remove('active'));

      if (data.action !== 'removed') btn.classList.add('active');

      Object.entries(data.counts).forEach(([rt, cnt]) => {
        const el = document.querySelector(`.reaction-count-${postId}-${rt}`);
        if (el) el.textContent = cnt || '';
      });
    }
  } catch (e) {
    console.error(e);
    alert("Reaction failed. Check your server logs.");
  }
}
</script>
{% endblock %}