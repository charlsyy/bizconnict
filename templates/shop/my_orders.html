{% extends "base.html" %}
{% block title %}My Orders — BizConnect{% endblock %}
{% block content %}
<div class="page">
  <span class="label">Buyer</span>
  <h1 class="mt-1 mb-5">My Orders</h1>

  {% if orders %}
  <div style="display:flex;flex-direction:column;gap:var(--sp-4);">
    {% for order in orders %}
    <div class="card">
      <div class="card-body">
        <div class="flex-between mb-3" style="flex-wrap:wrap;gap:var(--sp-2);">
          <div>
            <div style="font-family:var(--font-display);font-size:1rem;font-weight:700;">
              {{ order.order_number }}
            </div>
            <div class="text-xs text-muted mt-1">{{ order.created_at|date:"M d, Y H:i" }}</div>
          </div>
          <div class="flex gap-2" style="align-items:center;flex-wrap:wrap;">
            <span class="badge
              {% if order.status == 'delivered' %}badge-success
              {% elif order.status == 'cancelled' or order.status == 'refunded' %}badge-danger
              {% elif order.status == 'shipped' %}badge-dark
              {% else %}badge-warning{% endif %}">
              {{ order.get_status_display }}
            </span>
            <a href="{% url 'order_detail' order.pk %}" class="btn btn-outline btn-sm">Track Order</a>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Seller</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Item Status</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order.items.all %}
              <tr>
                <td>{{ item.product_name }}</td>
                <td>{{ item.seller.username|default:"—" }}</td>
                <td>{{ item.quantity }}</td>
                <td>&#8369;{{ item.subtotal|floatformat:2 }}</td>
                <td>
                  <span class="badge
                    {% if item.status == 'delivered' %}badge-success
                    {% elif item.status == 'cancelled' %}badge-danger
                    {% elif item.status == 'shipped' %}badge-dark
                    {% else %}badge-warning{% endif %}">
                    {{ item.get_status_display }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="flex-between mt-3"
             style="border-top:1px solid var(--border);padding-top:var(--sp-3);">
          <span class="text-sm text-muted">
            {{ order.items.count }} item{{ order.items.count|pluralize }}
          </span>
          <div class="flex gap-3" style="align-items:center;">
            {% with p=order.payment %}
            {% if not p or p.status == 'pending' %}
              <a href="{% url 'payment_page' order.pk %}" class="btn btn-gold btn-sm">Pay Now</a>
            {% elif p.status == 'submitted' %}
              <span class="badge badge-warning">Payment Verifying</span>
            {% elif p.status == 'confirmed' %}
              <span class="badge badge-success">Paid</span>
            {% endif %}
            {% endwith %}
            <span style="font-weight:700;color:var(--gold-dark);">
              &#8369;{{ order.total_amount|floatformat:2 }}
            </span>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="panel text-center" style="padding:var(--sp-9);">
    <p class="text-muted mb-4">No orders yet.</p>
    <a href="{% url 'product_list' %}" class="btn btn-gold">Start Shopping</a>
  </div>
  {% endif %}
</div>
{% endblock %}